# å°çº¢ä¹¦è§†é¢‘è§£ææµç¨‹

ä»¥ä¸‹æ˜¯è§£æå°çº¢ä¹¦è§†é¢‘çš„å…·ä½“æ­¥éª¤ä¸æ‰€éœ€çš„å…³é”®é“¾æ¥ï¼š

## æµç¨‹æ­¥éª¤

### 1. è¾“å…¥é“¾æ¥è§£æ
- ç”¨æˆ·è¾“å…¥å°çº¢ä¹¦é“¾æ¥ï¼Œå¯èƒ½æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
  - çŸ­é“¾æ¥ï¼Œä¾‹å¦‚ï¼š`https://xhslink.com/...`
  - æ™®é€šé“¾æ¥ï¼Œä¾‹å¦‚ï¼š`https://www.xiaohongshu.com/explore/...`
  - åˆ†äº«é“¾æ¥ï¼Œä¾‹å¦‚ï¼š`https://www.xiaohongshu.com/discovery/item/...`

88 è¯¡ç§˜ä¹‹ä¸»å‘å¸ƒäº†ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ï¼Œå¿«æ¥çœ‹å§ï¼ ğŸ˜† Ebsjwey8PSgXlMl ğŸ˜† http://xhslink.com/a/K8Jc0bï¼Œå¤åˆ¶æœ¬æ¡ä¿¡æ¯ï¼Œæ‰“å¼€ã€å°çº¢ä¹¦ã€‘AppæŸ¥çœ‹ç²¾å½©å†…å®¹ï¼

ï¼Œå¤åˆ¶æ‰“å¼€ä¼šè·³è½¬åˆ°å¦‚ä¸‹é“¾æ¥ï¼š  
https://www.xiaohongshu.com/discovery/item/67c8332b000000000d014493?app_platform=android&ignoreEngage=true&

15 å°‘å¥³ä¹é˜Ÿçš„å‘å–Šå®˜æ–¹å‘å¸ƒäº†ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ï¼Œå¿«æ¥çœ‹å§ï¼ ğŸ˜† ae2HsBnGKGZhJAs ğŸ˜† http://xhslink.com/a/dWXWmYAabï¼Œå¤åˆ¶æœ¬æ¡ä¿¡æ¯ï¼Œæ‰“å¼€ã€å°çº¢ä¹¦ã€‘AppæŸ¥çœ‹ç²¾å½©å†…å®¹ï¼

https://www.xiaohongshu.com/discovery/item/67cb94b1000000002803ff8b?app_platform=android&ignoreEngage=true


17 ä¸œæ˜ åŠ¨ç”»å‘å¸ƒäº†ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ï¼Œå¿«æ¥çœ‹å§ï¼ ğŸ˜† 2CPKUyWzQJkhOI0 ğŸ˜† http://xhslink.com/a/ewBnezKQvGBabï¼Œå¤åˆ¶æœ¬æ¡ä¿¡æ¯ï¼Œæ‰“å¼€ã€å°çº¢ä¹¦ã€‘AppæŸ¥çœ‹ç²¾å½©å†…å®¹ï¼
ç½‘é¡µæºç ä¸­ç›´æ¥å°±æœ‰è§†é¢‘é“¾æ¥ï¼Œ

https://www.xiaohongshu.com/discovery/item/67f4cf74000000001d023988?app_platform=android&ignoreEngage=true&app_version=
æŸ¥çœ‹exiftoolå¯çŸ¥

â€œå…¨çƒ Web å›¾æ ‡
xiaozhongpai.com
https://www.xiaozhongpai.com
å‰ªæ˜ APPå¯¼å‡ºçš„è§†é¢‘æ–‡ä»¶ä¼šæºå¸¦è¯†åˆ«ç¬¦ä¿¡æ¯ - å°ä¼—æ´¾
/images/search?view=detailV2&ccid=ecPu0dtW&id=000109F2777AB0B3EFFC67E6668ACCFCEC920102&thid=OIP.ecPu0dtWYbHSEq_ejjva8QHaJ8&mediaurl=https://www.xiaozhongpai.com/wp-content/uploads/2020/08/jianying02.jpg&q=douyin_beauty_me&ck=E2140F64864B1A69CDA4D9468FDCED12&idpp=rc&idpview=singleimage&form=rc2idp
æœ¬æ–‡ä»‹ç»äº†å‰ªæ˜ APPå¯¼å‡ºçš„è§†é¢‘æ–‡ä»¶åœ¨å±æ€§å¤‡æ³¨é‡Œä¼šæ·»åŠ douyin_beauty_meâ€

å…¶ä¸­
htmlä¸­ï¼š

```
<meta name="og:video" content="è¿™é‡Œæ˜¯æœ‰æ°´å°è§†é¢‘é“¾æ¥">
```
æ— æ°´å°åŸé“¾æ¥ï¼š
ç›´æ¥åœ¨htmlä¸­çš„"originVideoKey":"æ— æ°´å°è§†é¢‘id"

```
r = requests.get(url)
key = re.findall(r'{\"originVideoKey\":\".*?\"}', r.text)


```

ç„¶å http://sns-video-bd.xhscdn.com/{æ— æ°´å°è§†é¢‘id} å°±æ˜¯æ— æ°´å°è§†é¢‘é“¾æ¥

```

import requests
import re
import json

link = 'https://www.xiaohongshu.com/explore/65e2c4fb00000000030367bd'

def work(url: str) -> dict:
    r = requests.get(url)
    if r.status_code == 200:

        url_with_watermark = re.findall(r'<meta name="og:video" content="(.*?)">', r.text)
        if url_with_watermark:
            url_with_watermark = url_with_watermark[0]
        else:
            url_with_watermark = None
        
        key = re.findall(r'{\"originVideoKey\":\".*?\"}', r.text)
        if key:
            url_without_watermark = "http://sns-video-bd.xhscdn.com/" + json.loads(key[0])["originVideoKey"]

```
#### æ“ä½œ

- æ£€æµ‹é“¾æ¥ç±»å‹ï¼š
  - è‹¥ä¸ºçŸ­é“¾æ¥ï¼Œä½¿ç”¨çŸ­é“¾æ¥æ‰©å±•å·¥å…·å°†å…¶è½¬æ¢ä¸ºæ™®é€šé“¾æ¥ã€‚
  - å¦‚æœæ˜¯æ™®é€šé“¾æ¥æˆ–åˆ†äº«é“¾æ¥ï¼Œç›´æ¥ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–é“¾æ¥ã€‚

---

### 2. æå–ç¬”è®° ID
- ä»è§£æåçš„é“¾æ¥ä¸­æå–ç¬”è®° IDã€‚

#### æ“ä½œ
- åˆ†æé“¾æ¥è·¯å¾„ï¼Œæå–è·¯å¾„ä¸­çš„æœ€åä¸€ä¸ªéç©ºéƒ¨åˆ†ä½œä¸ºç¬”è®° IDã€‚

---

### 3. è·å– HTML é¡µé¢å†…å®¹
- æ ¹æ®é“¾æ¥æŠ“å–å¯¹åº”çš„ HTML é¡µé¢ã€‚

#### æ“ä½œ
- ä½¿ç”¨ HTTP è¯·æ±‚å·¥å…·ï¼ˆå¦‚ `HttpUtil.getHtml`ï¼‰è·å–é¡µé¢ HTMLã€‚

---

### 4. æå–é¡µé¢ä¸­çš„ JavaScript æ•°æ®
- ä» HTML é¡µé¢ä¸­æ‰¾åˆ°åŒ…å«ç¬”è®°è¯¦ç»†ä¿¡æ¯çš„è„šæœ¬ã€‚

#### æ“ä½œ
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä½ `<script>window.__INITIAL_STATE__=...</script>`ã€‚
- æå–å…¶ä¸­çš„ JSON æ•°æ®ã€‚

---

### 5. è§£æç¬”è®°è¯¦ç»†ä¿¡æ¯
- å°†æå–çš„ JSON æ•°æ®è§£æä¸ºç»“æ„åŒ–çš„ç¬”è®°ä¿¡æ¯ã€‚

#### æ“ä½œ
- å®šä½ç¬”è®°ä¿¡æ¯ï¼š
  ```
  json['note']['noteDetailMap'][linkId]['note']
  ```
- æå–å­—æ®µï¼š
  - `noteId`: ç¬”è®° ID
  - `title`: ç¬”è®°æ ‡é¢˜
  - `desc`: ç¬”è®°æè¿°
  - `type`: ç¬”è®°ç±»å‹ï¼ˆ`normal` è¡¨ç¤ºå›¾æ–‡ï¼Œ`video` è¡¨ç¤ºè§†é¢‘ï¼‰

---

### 6. æå–è§†é¢‘ä¿¡æ¯
- å¦‚æœç¬”è®°ç±»å‹ä¸ºè§†é¢‘ï¼Œæå–è§†é¢‘èµ„æºã€‚

#### æ“ä½œ
1. æ‰¾åˆ° `originVideoKey`ï¼š
   ```
   noteInfo['video']['consumer']['originVideoKey']
   ```
2. æ„å»ºè§†é¢‘ URLï¼š
   ```
   https://sns-video-bd.xhscdn.com/{originVideoKey}
   ```
3. è·å–è§†é¢‘æ—¶é•¿ï¼š
   ```
   noteInfo['video']['capa']['duration']
   ```
4. è·å–æ–‡ä»¶å¤§å°ï¼š
   - ä½¿ç”¨ HTTP è¯·æ±‚å·¥å…·ï¼Œè·å–è§†é¢‘æ–‡ä»¶çš„å¤§å°ã€‚

---

## ç»“æœ
æœ€ç»ˆï¼Œæ‚¨å¯ä»¥è·å¾—ä»¥ä¸‹ä¿¡æ¯ï¼š
- è§†é¢‘ URL: `https://sns-video-bd.xhscdn.com/{originVideoKey}`
- è§†é¢‘æ—¶é•¿
- è§†é¢‘æ–‡ä»¶å¤§å°




å‚è€ƒï¼šè§£æå°çº¢ä¹¦æ— æ°´å°è§†é¢‘ç›´é“¾ | å›å£°https://iecho.cc/2024/03/03/decode-xiaohongshu-video-url/

https://github.com/nilaoda/xhs_app/blob/main/lib/service/file_downloader.dart


```
import re
import requests

class XiaohongshuVideoExtractor:
    def __init__(self):
        self.short_link_regex = re.compile(r'https?://xhslink\.com/\S+')
        self.script_regex = re.compile(r'<script>window.__INITIAL_STATE__=(.*?)</script>')

    def expand_short_url(self, url):
        return requests.head(url, allow_redirects=True).url

    def extract_video_url(self, input_url):
        # Expand short links
        if self.short_link_regex.match(input_url):
            input_url = self.expand_short_url(input_url)

        # Fetch HTML content
        html = requests.get(input_url).text

        # Extract JSON script
        initial_state = self.script_regex.search(html).group(1)
        json_data = eval(initial_state)  # Use a safer JSON parser in production

        # Extract video key and construct video URL
        video_key = json_data['note']['noteDetailMap'].popitem()[1]['note']['video']['consumer']['originVideoKey']
        return f"https://sns-video-bd.xhscdn.com/{video_key}"

# Example usage
extractor = XiaohongshuVideoExtractor()
video_url = extractor.extract_video_url("https://xhslink.com/example")
print("Video URL:", video_url)
```
